<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>modules/pagamento/pagamento-parcelas.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Pagamento.html">Pagamento</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Pagamento.html#.init">init</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-PagamentoForm.html">PagamentoForm</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PagamentoForm.html#.mount">mount</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-PagamentoParcelas.html">PagamentoParcelas</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PagamentoParcelas.html#.mount">mount</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-PagamentoPrestador.html">PagamentoPrestador</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PagamentoPrestador.html#.mount">mount</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-PagamentoSaldos.html">PagamentoSaldos</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PagamentoSaldos.html#.mount">mount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PagamentoSaldos.html#.setBalance">setBalance</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PagamentoSaldos.html#.setCount">setCount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PagamentoSaldos.html#.update">update</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-PagamentoTask.html">PagamentoTask</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PagamentoTask.html#.addError">addError</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PagamentoTask.html#.mount">mount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PagamentoTask.html#.removeError">removeError</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-ParcelasService.html">ParcelasService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ParcelasService.html#.getInstallments">getInstallments</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-PrestadorService.html">PrestadorService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PrestadorService.html#.getContractorCdn">getContractorCdn</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Utils.html">Utils</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Utils.html#.addMonths">addMonths</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Utils.html#.currencyToNumber">currencyToNumber</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Utils.html#.getMonthNameByNumber">getMonthNameByNumber</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Utils.html#.numberToCurrency">numberToCurrency</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Utils.html#.parseDate">parseDate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Utils.html#.setValue">setValue</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">modules/pagamento/pagamento-parcelas.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import Tabs from '../../components/tabs/index'
import { currencyToNumber } from '../../helpers/utils'

import { getInstallments } from '../../services/parcelas-service'
import { getTabs } from './templates/parcelas-nav'
import { getPanels } from './templates/parcelas-panels'

/**
 * Carrega e renderiza os painÃ©is e menu das parcelas para pagamento.
 *
 * @module PagamentoParcelas
 */

const PagamentoParcelas = function () {
  const $refs = {
    tabsNav: document.querySelector('#tab-nav-installments'),
    tabsPanels: document.querySelector('#tab-panels-installments'),
    tabForm: document.querySelector('#form-installments'),
    solicitacao: document.querySelector('[xname=inpsolicitacao]'),
    parcela: document.querySelector('[xname=inpparcelaDoPagamento]'),
    valorHoraProposta: document.querySelector('[xname=inpvalorHoraDaProposta]')
  }

  /**
   * @memberof module:PagamentoParcelas
   * @property {object} emitter - instÃ¢ncia global do event emitter
   * @property {boolean} readonly - se os painÃ©is devem ser todos carregados em modo leitura (sem formulÃ¡rio)
   * @property {?object} tabs - instÃ¢ncia do componente `Tabs` do menu das parcelas
   * @property {string|number} rsaCodFlowExecute - CodFlowExecute (instÃ¢ncia) do processo de RSA que originou as parcelas
   * @property {string|number} currentInstallment - nÃºmero da parcela atual para pagamento
   */
  const state = {
    emitter: null,
    readonly: false,
    tabs: null,
    rsaCodFlowExecute: null,
    currentInstallment: null
  }

  return {
    mount
  }

  /**
   * ðŸ”‘ MÃ©todos PÃºblicos
   */

  /**
   * Realiza a montagem do mÃ³dulo
   * @public
   * @memberof module:PagamentoParcelas
   * @param {object} config.emitter - instÃ¢ncia global do event emitter
   * @param {object} config.readonly - se os painÃ©is devem ser todos carregados em modo leitura (sem formulÃ¡rio)
   */
  function mount ({ emitter, readonly }) {
    state.emitter = emitter
    state.readonly = readonly

    setup()

    getInstallments({
      codFlowExecuteMaster: state.rsaCodFlowExecute
    })
      .then(setCurrent)
      .then(setCount)
      .then(render)
      .then(calculateBalance)
      .then(handlePendencies)
  }

  /**
   * ðŸ”’ MÃ©todos Privados
   */

  function setup () {
    state.rsaCodFlowExecute = $refs.solicitacao.value
    state.currentInstallment = $refs.parcela.value
  }

  function setCurrent (installments) {
    return installments.map(installment => ({
      ...installment,
      parcelaAtiva:
        installment.parcelaDoPagamento === state.currentInstallment
    }))
  }

  function setCount (installments) {
    const approvedCount = installments
      .filter(({ autorizado }) => autorizado).length

    state.emitter.emit('installments:count', {
      approved: approvedCount,
      total: installments.length
    })

    return installments
  }

  function render (installments) {
    const tabNavItems = getTabs(installments)
    const tabPanels = getPanels(installments, {
      valorHoraDaProposta: $refs.valorHoraProposta.value,
      readonly: state.readonly
    })

    $refs.tabsNav
      .insertAdjacentHTML('afterbegin', tabNavItems)

    $refs.tabsPanels
      .insertAdjacentHTML('afterbegin', tabPanels)

    if (!state.readonly) {
      $refs.tabsPanels
        .querySelector('.o-tab-panel.-active')
        .appendChild($refs.tabForm)
    }

    state.tabs = Tabs($refs.tabsNav)

    return installments
  }

  function calculateBalance (installments) {
    const balance = getBalance(installments)

    state.emitter.emit('installments:balance', balance)

    /**
     * @todo
     * - se for Ãºltimo pagamento sugerir saldo restante
     */

    return installments
  }

  function getBalance (installments) {
    return installments
      .filter(({ parcelaAtiva }) => !parcelaAtiva)
      .reduce((payment, installment) => {
        const service = currencyToNumber(installment?.valorAPagar || '')
        const workload = parseInt(installment.cargaHorariaDoPagamento)
        const expenses = currencyToNumber(installment?.despesasAPagar || '')
        const total = currencyToNumber(installment?.valorTotalParcela || '')

        return {
          service: payment.service + service,
          workload: payment.workload + workload,
          expenses: payment.expenses + expenses,
          total: payment.total + total
        }
      }, {
        service: 0,
        workload: 0,
        expenses: 0,
        total: 0
      })
  }

  function handlePendencies (installments) {
    const { parcelaDoPagamento } = installments
      .find(({ parcelaAtiva }) => parcelaAtiva)

    const currentIndex = parseInt(parcelaDoPagamento)

    if (currentIndex === 1) return

    const isReadyToPayment = installments
      .filter(({ parcelaDoPagamento }) =>
        parseInt(parcelaDoPagamento) &lt; currentIndex
      )
      .every(({ autorizado }) => autorizado)

    if (isReadyToPayment) return

    return addPendencieAlert()
  }

  function addPendencieAlert () {
    state.emitter.emit('installments:addError', {
      type: 'installments_pending',
      message: 'Existem parcelas anteriores a esta pendentes de aprovaÃ§Ã£o.'
    })
  }
}

export default PagamentoParcelas()
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Sun Aug 01 2021 21:55:46 GMT-0300 (HorÃ¡rio PadrÃ£o de BrasÃ­lia) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
