<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>services/parcelas-service.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Pagamento.html">Pagamento</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Pagamento.html#.init">init</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-PagamentoForm.html">PagamentoForm</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PagamentoForm.html#.mount">mount</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-PagamentoParcelas.html">PagamentoParcelas</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PagamentoParcelas.html#.mount">mount</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-PagamentoPrestador.html">PagamentoPrestador</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PagamentoPrestador.html#.mount">mount</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-PagamentoSaldos.html">PagamentoSaldos</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PagamentoSaldos.html#.mount">mount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PagamentoSaldos.html#.setBalance">setBalance</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PagamentoSaldos.html#.setCount">setCount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PagamentoSaldos.html#.update">update</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-PagamentoTask.html">PagamentoTask</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PagamentoTask.html#.addError">addError</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PagamentoTask.html#.mount">mount</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PagamentoTask.html#.removeError">removeError</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-ParcelasService.html">ParcelasService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ParcelasService.html#.getInstallments">getInstallments</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-PrestadorService.html">PrestadorService</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-PrestadorService.html#.getContractorCdn">getContractorCdn</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-Utils.html">Utils</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Utils.html#.addMonths">addMonths</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Utils.html#.currencyToNumber">currencyToNumber</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Utils.html#.getMonthNameByNumber">getMonthNameByNumber</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Utils.html#.numberToCurrency">numberToCurrency</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Utils.html#.parseDate">parseDate</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-Utils.html#.setValue">setValue</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">services/parcelas-service.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { parseDate } from '../helpers/utils'

/**
 * Serviço para captura das informações das parcelas através do uso de fontes de dados do Orquestra BPM
 * @see PA-CORP.004 - Parcelas para Pagamento
 * @module ParcelasService
 */

const {
  DATASOURCE_BASE_URL,
  DATASOURCE_PARCELAS
} = process.env

const ORQUESTRA_PARCELAS_URL =
  DATASOURCE_BASE_URL + DATASOURCE_PARCELAS

/**
 * Retorna os dados de todas as parcelas de uma determinada RSA
 * @param {object} config - parâmetros de configuração
 * @param {string|number} config.codFlowExecuteMaster - codFlowExecute da RSA
 * @returns {object[]} parcelas para pagamento da RSA
 */
export function getInstallments ({ codFlowExecuteMaster }) {
  const url = new URL(ORQUESTRA_PARCELAS_URL)

  const params = {
    inpcodFlowExecuteMaster: codFlowExecuteMaster
  }

  url.search = new URLSearchParams(params).toString()

  return fetch(url)
    .then(res => res.json())
    .then(({ success }) => {
      if (!success.length) return false

      return success
        .reduce(groupFieldsById, [])
        .map(setInstallmentStatus)
        .sort((a, b) =>
          sortAscByProp('parcelaDoPagamento', [a, b])
        )
    })
}

const groupFieldsById = (installments, { fields }) => {
  const firstField = {
    id: fields.codFlowExecute,
    [fields.id]: fields.value
  }

  if (!installments.length) return [firstField]

  const installmentIndex = installments
    .findIndex(({ id }) => fields.codFlowExecute === id)

  if (installmentIndex &lt; 0) {
    installments.push(firstField)
  } else {
    installments[installmentIndex][fields.id] = fields.value
  }

  return installments
}

const setInstallmentStatus = installment => ({
  ...installment,
  autorizado: isAuthorized(installment?.statusDoPagamento),
  atrasado: isOverdue(installment?.dataParaConfirmacao)
})

const isAuthorized = status =>
  status === 'Pagamento Autorizado'

const isOverdue = date => {
  const plannedDate = parseDate(date)
  const today = new Date(new Date().setHours(0, 0, 0, 0))

  return today.getTime() > plannedDate.getTime()
}

const sortAscByProp = (prop, [a, b]) =>
  parseInt(a[prop]) - parseInt(b[prop])
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Sun Aug 01 2021 21:55:46 GMT-0300 (Horário Padrão de Brasília) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
